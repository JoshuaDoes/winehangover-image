#!/data/data/com.termux/files/usr/bin/bash

HOSTER=JoshuaDoes
REPO="https://github.com/JoshuaDoes/winehangover-image"
BRANCH=dev
VER="v1.10.10"

export WINEPREFIX="$HOME/.winehangover"
export CACHE="$WINEPREFIX/.cache"
export WINEPATH="$WINEPREFIX/wine"
export WINEBIN="$WINEPATH/arm64-v8a/bin"
export WINELIB="$WINEPATH/arm64-v8a/lib/wine"
export WINELIBWIN="$WINELIB/aarch64-windows"
export TESTPATH="$WINEPREFIX/test"
export PATH="$WINEBIN:$PATH"

export VK_ICD_FILENAMES=$PREFIX/share/vulkan/icd.d/wrapper_icd.aarch64.json
export MESA_VK_WSI_PRESENT_MODE=mailbox
export DISPLAY=:0

export MNT="$WINEPREFIX/dosdevices"
export C="$WINEPREFIX/drive_c"
export T="$MNT/t:"
export Z="$MNT/z:"

export WINEARCH=win64

export WINEDLLOVERRIDES="d3d8,d3d9,d3d10core,d3d11,dxgi=n,b"
if [ ! -f $C/windows/system32/d3d8.dll ]; then
  WINEDLLOVERRIDES="d3d9,d3d10,d3d10_1,d3d10core,d3d11,dxgi=n,b"
fi

export DXVK_HUD=version,fps,api,gpuload,devinfo,compiler,scale=0.65

info() {
  echo ""
  echo "  Termux/Hangover Launcher"
  echo "    Hosted by $HOSTER"
  echo "    > $VER"
  echo "  REPO: $REPO"
  echo ""
  echo "Most recent changelog message:"
  pushd $CACHE
  echo "  $(git log -1 --pretty=format:%B | cat)"
  popd
}

echo ""
winedesktop() {
  wine explorer /desktop=shell,-1x-1 "$1"
}
if [ -z $HANGOVERDBG ]; then
  pushd() {
    command pushd "$@" >/dev/null
  }
  popd() {
    command popd "$@" >/dev/null
  }
  wine() {
    command wine "$@" >/dev/null 2>&1
  }
  winedesktop() {
    wine explorer /desktop=shell,-1x-1 "$@" >/dev/null 2>&1
  }
  openbox-session() {
    command openbox-session >/dev/null 2>&1
  }
  xfce4-session() {
    command xfce4-session >/dev/null 2>&1
  }
else
  echo "  > RUNNING IN DEBUG MODE!"
fi

info
echo ""

if [ -z "$DE" ]; then
  PS3='  Which desktop environment should we boot? (1-2) '
  menuvar=("Wine" "Openbox" "Exit")
  select menuvar in "${menuvar[@]}"
  do
    case $menuvar in
      "Wine")
        export DE=wine
        break;;
      "Openbox")
        export DE=openbox
        break;;
      "Xfce4")
        export DE=xfce4
        break;;
      "Exit")
        exit 0
        break;;
      *) echo "Invalid option.";;
    esac
  done
  echo ""
fi

if [ -z "$DESHELL" ]; then
  PS3='  What should we launch on startup? (1-5) '
  menuvar=("Wine Explorer" "Explorer++" "7-Zip" "winecfg" "Exit")
  select menuvar in "${menuvar[@]}"
  do
    case $menuvar in
      "Wine Explorer")
        export DESHELL=wine
        break;;
      "Explorer++")
        export DESHELL=explorer++
        break;;
      "7-Zip")
        export DESHELL=7z
        break;;
      "VLC Media Player")
        export DESHELL=vlc
        break;;
      "winecfg")
        export DESHELL=winecfg
        break;;
      "Exit")
        exit 0
        break;;
      *) echo "Invalid option.";;
    esac
  done
  echo ""
fi

start() {
  LD_PRELOAD_OLD=$LD_PRELOAD
  if [ $(getprop ro.config.knox) ]; then
    export LD_PRELOAD=/system/lib64/libskcodec.so
  fi
  taskset -c 0-2 pulseaudio \
    --start \
    --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" \
    --exit-idle-time=-1
  export LD_PRELOAD=$LD_PRELOAD_OLD

  echo ""
  echo "  > Starting an X server"
  termux-x11 -retro $DISPLAY >/dev/null 2>&1 &
  export TXPID=$!

  am start --user 0 -n com.termux.x11/.MainActivity >/dev/null 2>&1
  sleep 1

  export LD_LIBRARY_PATH="$TESTPATH"
  export PULSE_SERVER=127.0.0.1

  # Import Hangover registry on every boot
  wine regedit /s $WINEPREFIX/hangover.reg

  case $DE in
    wine)
      case $DESHELL in
        wine)
          winedesktop explorer &
          ;;
        explorer++)
          winedesktop $C/bin/Explorer++.exe &
          ;;
        7z)
          winedesktop "$C/Program Files/7-Zip/7zFM.exe" &
          ;;
        vlc)
          winedesktop "$C/Program Files/VideoLAN/VLC/vlc.exe" -I qt &
          ;;
        winecfg)
          wine explorer /desktop=shell,-1x-1 winecfg &
          ;;
      esac
      ;;
    openbox)
      openbox-session &
      ;;
    xfce4)
      xfce4-session &
      ;;
  esac
  DEPID=$!

  sleep 1

  if [ $DE != wine ]; then
    case $DESHELL in
      wine)
        wine explorer &
        ;;
      explorer++)
        wine $C/bin/Explorer++.exe &
        ;;
      7z)
        wine "$C/Program Files/7-Zip/7zFM.exe" &
        ;;
      vlc)
        wine "$C/Program Files/VideoLAN/VLC/vlc.exe" -I qt &
        ;;
      winecfg)
        winecfg &
        ;;
    esac

    sleep 1
  fi

  if [ -z $HANGOVERDBG ]; then
    wine $C/bin/vulkaninfo-x64.exe &
    sleep 2.5

    wine $C/bin/Coreinfo64.exe
  fi

  wait $DEPID
  stop
  sleep 1
  echo ""
}

stop() {
  echo ""
  echo "  > Stopping the X server"
  am broadcast -a com.termux.x11.ACTION_STOP -p com.termux.x11 >/dev/null 2>&1
  pkill -x com.termux.x11 >/dev/null 2>&1
  kill $(jobs -p) >/dev/null 2>&1
  kill $TXPID >/dev/null 2>&1
  sleep 1
  echo "  > Shutting down Wine prefix"
  wineboot --end-session >/dev/null 2>&1
  wineboot --kill --force >/dev/null 2>&1
  wineserver --kill=9 >/dev/null 2>&1
  wineserver --wait >/dev/null 2>&1
}

stop
start
