#!/data/data/com.termux/files/usr/bin/bash

HOSTER=JoshuaDoes
REPO="https://github.com/JoshuaDoes/winehangover-image"
BRANCH=dev
VER="v1.10.2"

info() {
  echo ""
  echo "  Termux/Hangover Launcher"
  echo "    Hosted by $HOSTER"
  echo "    > $VER"
  echo "  REPO: $REPO"
}

export WINEPREFIX=$HOME/.winehangover
export WINEPATH=$WINEPREFIX/wine
export TESTPATH=$WINEPREFIX/test
export WINEBIN=$WINEPATH/arm64-v8a/bin
export PATH="$WINEBIN:$PATH"
export VK_ICD_FILENAMES=$PREFIX/share/vulkan/icd.d/wrapper_icd.aarch64.json
export DISPLAY=:0

export MNT="$WINEPREFIX/dosdevices"
export C="$WINEPREFIX/drive_c"
export T="$MNT/t:"
export Z="$MNT/z:"

export WINEDLLOVERRIDES="d3d8,d3d9,d3d10core,d3d11,dxgi=n,b"
if [ ! -f $C/windows/system32/d3d8.dll ]; then
  WINEDLLOVERRIDES="d3d9,d3d10,d3d10_1,d3d10core,d3d11,dxgi=n,b"
fi

export DXVK_HUD=version,fps,api,gpuload,devinfo,compiler,scale=0.65
export MESA_VK_WSI_PRESENT_MODE=mailbox

echo ""
if [ -z $HANGOVERDBG ]; then
  wine() {
    command wine "$@" > /dev/null 2>&1
  }
  openbox-session() {
    command openbox-session > /dev/null 2>&1
  }
  xfce4-session() {
    command xfce4-session > /dev/null 2>&1
  }
else
  echo "  > RUNNING IN DEBUG MODE!"
fi

info
echo ""

if [ -z "$DE" ]; then
  PS3='  Which desktop environment should we boot? (1-3) '
  #menuvar=("Wine" "Openbox" "Xfce4" "Exit")
  menuvar=("Wine" "Openbox" "Exit")
  select menuvar in "${menuvar[@]}"
  do
    case $menuvar in
      "Wine")
        export DE=wine
        break;;
      "Openbox")
        export DE=openbox
        break;;
      "Xfce4")
        export DE=xfce4
        break;;
      "Exit")
        exit 0
        break;;
      *) echo "Invalid option.";;
    esac
  done
  echo ""
fi

if [ -z "$DESHELL" ]; then
  PS3='  What should we launch on startup? (1-4) '
  menuvar=("Wine Explorer" "Explorer++" "winecfg" "vulkaninfo" "Exit")
  select menuvar in "${menuvar[@]}"
  do
    case $menuvar in
      "Wine Explorer")
        export DESHELL=wine
        break;;
      "Explorer++")
        export DESHELL=explorer++
        break;;
      "winecfg")
        export DESHELL=winecfg
        break;;
      "vulkaninfo")
        export DESHELL=vkinfo
        break;;
      "Exit")
        exit 0
        break;;
      *) echo "Invalid option.";;
    esac
  done
  echo ""
fi

start() {
  LD_PRELOAD_OLD=$LD_PRELOAD
  if [ $(getprop ro.config.knox) ]; then
    export LD_PRELOAD=/system/lib64/libskcodec.so
  fi
  taskset -c 0-2 pulseaudio \
    --start \
    --load="module-native-protocol-tcp auth-ip-acl=127.0.0.1 auth-anonymous=1" \
    --exit-idle-time=-1
  export LD_PRELOAD=$LD_PRELOAD_OLD

  termux-x11 -retro $DISPLAY >/dev/null 2>&1 &
  export TXPID=$!

  am start --user 0 -n com.termux.x11/.MainActivity >/dev/null 2>&1
  sleep 1

  export LD_LIBRARY_PATH="$TESTPATH"
  export PULSE_SERVER=127.0.0.1

  # Import Hangover registry on every boot
  wine regedit /s $WINEPREFIX/hangover.reg

  case $DE in
    wine)
      case $DESHELL in
        wine)
          wine explorer /desktop=shell,-1x-1 explorer &
          ;;
        explorer++)
          wine explorer /desktop=shell,-1x-1 $C/bin/Explorer++.exe &
          ;;
        winecfg)
          wine explorer /desktop=shell,-1x-1 winecfg &
          ;;
        vkinfo)
          wine explorer /desktop=shell,-1x-1 $C/bin/vulkaninfo-x64.exe &
          ;;
      esac
      ;;
    openbox)
      openbox-session &
      ;;
    xfce4)
      xfce4-session &
      ;;
  esac
  DEPID=$!

  sleep 1

  if [ $DE != wine ]; then
    case $DESHELL in
      wine)
        wine explorer &
        ;;
      explorer++)
        wine $C/bin/Explorer++.exe &
        ;;
      winecfg)
        winecfg &
        ;;
      vkinfo)
        wine $C/bin/vulkaninfo-x64.exe &
        ;;
    esac

    sleep 1
  fi

  if [ -z $HANGOVERDBG ]; then
    wine $C/bin/vulkaninfo-x64.exe &
    sleep 2.5

    wine $C/bin/Coreinfo64.exe
  fi

  wait $DEPID
  stop
  sleep 1
  echo ""
}

stop() {
  am broadcast -a com.termux.x11.ACTION_STOP -p com.termux.x11 >/dev/null 2>&1
  pkill -x com.termux.x11 >/dev/null 2>&1
  kill $(jobs -p) >/dev/null 2>&1
  kill $TXPID >/dev/null 2>&1
  sleep 1
}

stop
start
